#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
パニパニ翻訳アプリ (Kivy版 - Windows対応)
まずはWindows上でテストしてから、別の方法でAPK化
"""

from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.label import Label
from kivy.uix.textinput import TextInput
from kivy.uix.button import Button
from kivy.uix.scrollview import ScrollView
from kivy.uix.popup import Popup
from kivy.config import Config
from kivy.resources import resource_add_path
from kivy.core.text import LabelBase
import re
import os

# ウィンドウサイズを設定
Config.set('graphics', 'width', '400')
Config.set('graphics', 'height', '700')

# 日本語フォントの設定
def setup_japanese_font():
    # Windowsの日本語フォントパスを探す
    font_paths = [
        'C:/Windows/Fonts/msgothic.ttc',  # MS Gothic
        'C:/Windows/Fonts/meiryo.ttc',    # Meiryo
        'C:/Windows/Fonts/YuGothM.ttc',   # Yu Gothic Medium
        'C:/Windows/Fonts/NotoSansCJK-Regular.ttc',  # Noto Sans CJK
    ]
    
    for font_path in font_paths:
        if os.path.exists(font_path):
            LabelBase.register(name='Japanese', fn_regular=font_path)
            print(f"Japanese font loaded: {font_path}")
            return True
    
    print("No Japanese font found, using default")
    return False

# 日本語フォントをセットアップ
setup_japanese_font()

class PaniPaniTranslator:
    def __init__(self):
        # パニパニの17の基本語彙
        self.panipani_vocab = {
            'kai': '行く、来る、歩く、動く、変わる',
            'kim': '得る、食べる、飲む',
            'ma': 'いる、ある、生きている',
            'mai': '生物',
            'na': '私、あなた、あの人（たち）、これ、それ、あれ',
            'ni': '大きい、高い、多い、たくさん、とても、成長する',
            'pa': '言う、話す、聞く、書く、見る、読む、言葉、音、文字、絵、写真、刺激',
            'pu': '～ではない、～しない',
            'pin': '光、明るい、色',
            'ru': '場所、時間',
            'sa': '知る、わかる、知識、習う、教わる、考える、考え',
            'sai': 'よいこと、楽しい、美しい',
            'sin': '使う',
            'ta': '誰',
            'tin': 'する、作る',
            'kin': '得る、もらう、手に入れる',
            'nan': '何'
        }
        
        # 日本語→パニパニの基本的な翻訳辞書
        self.translation_dict = {
            # 代名詞
            '私': 'na', 'あなた': 'na', '彼': 'na', '彼女': 'na',
            'これ': 'na', 'それ': 'na', 'あれ': 'na', '誰': 'ta', '何': 'nan',
            
            # 動詞
            '行く': 'kai', '行き': 'kai', '来る': 'kai', '歩く': 'kai', '動く': 'kai', '変わる': 'kai',
            '食べる': 'kim', '飲む': 'kim', '得る': 'kin', 'もらう': 'kin',
            'いる': 'ma', 'ある': 'ma', '生きる': 'ma',
            '言う': 'pa', '話す': 'pa', '聞く': 'pa', '書く': 'pa', '見る': 'pa', '読む': 'pa',
            '知る': 'sa', 'わかる': 'sa', '習う': 'sa', '学ぶ': 'sa', '教える': 'sa', '考える': 'sa',
            '使う': 'sin', 'する': 'tin', '作る': 'tin',
            
            # 形容詞・副詞
            '大きい': 'ni', '高い': 'ni', '多い': 'ni', 'たくさん': 'ni', 'とても': 'ni',
            'よい': 'sai', 'いい': 'sai', '楽しい': 'sai', '美しい': 'sai', '明るい': 'pin',
            
            # 名詞
            '生物': 'mai', '動物': 'mai', '人': 'mai', '人間': 'mai',
            '言葉': 'pa', '音': 'pa', '文字': 'pa', '絵': 'pa', '写真': 'pa',
            '知識': 'sa', '場所': 'ru', '時間': 'ru', '光': 'pin', '色': 'pin',
            
            # 否定
            'ない': 'pu', 'ません': 'pu', 'じゃない': 'pu', 'ではない': 'pu',
        }
    
    def preprocess_japanese(self, text):
        """日本語テキストの前処理"""
        text = re.sub(r'[。、！？]', '', text)
        text = re.sub(r'[はをにへでから]', ' ', text)
        return text.strip()
    
    def translate_word(self, word):
        """単語をパニパニ語に翻訳"""
        if word in self.translation_dict:
            return self.translation_dict[word]
        
        # 動詞の活用形を処理
        if word.endswith('ます'):
            base = word[:-2]
            if base in self.translation_dict:
                return self.translation_dict[base]
        
        return word  # 借用語として残す
    
    def translate_sentence(self, japanese_text):
        """日本語の文をパニパニ語に翻訳"""
        if not japanese_text.strip():
            return ""
        
        processed = self.preprocess_japanese(japanese_text)
        words = processed.split()
        
        panipani_words = []
        subject = None
        
        for word in words:
            translated = self.translate_word(word)
            panipani_words.append(translated)
            
            if translated == 'na' and subject is None:
                subject = 'na'
        
        if subject == 'na' and len(panipani_words) > 1:
            result = f"na na {' '.join(panipani_words[1:])}"
        else:
            result = ' '.join(panipani_words)
        
        return result

class MainWidget(BoxLayout):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.orientation = 'vertical'
        self.padding = [10, 10]
        self.spacing = 10
        
        self.translator = PaniPaniTranslator()
        self.setup_ui()
    
    def setup_ui(self):
        # タイトル
        title = Label(
            text='パニパニ翻訳アプリ',
            size_hint_y=None,
            height=50,
            font_size='20sp',
            font_name='Japanese',
            bold=True,
            color=[0.2, 0.2, 0.8, 1]
        )
        self.add_widget(title)
        
        # 日本語入力エリア
        japanese_label = Label(
            text='日本語を入力:',
            size_hint_y=None,
            height=30,
            font_size='16sp',
            font_name='Japanese',
            halign='left',
            color=[0.3, 0.3, 0.3, 1]
        )
        japanese_label.bind(size=japanese_label.setter('text_size'))
        self.add_widget(japanese_label)
        
        self.japanese_input = TextInput(
            multiline=True,
            size_hint_y=None,
            height=100,
            font_size='16sp',
            font_name='Japanese',
            hint_text='例: 今日は会社を休んで病院へ行きます',
            background_color=[1, 1, 1, 1],
            foreground_color=[0, 0, 0, 1]
        )
        self.add_widget(self.japanese_input)
        
        # ボタンエリア
        button_layout = BoxLayout(
            size_hint_y=None,
            height=50,
            spacing=10
        )
        
        translate_btn = Button(
            text='翻訳',
            font_size='16sp',
            font_name='Japanese',
            bold=True,
            background_color=[0.2, 0.6, 1, 1],
            color=[1, 1, 1, 1]
        )
        translate_btn.bind(on_press=self.translate)
        button_layout.add_widget(translate_btn)
        
        clear_btn = Button(
            text='クリア',
            font_size='16sp',
            background_color=[0.8, 0.8, 0.8, 1],
            color=[0.2, 0.2, 0.2, 1]
        )
        clear_btn.bind(on_press=self.clear_all)
        button_layout.add_widget(clear_btn)
        
        vocab_btn = Button(
            text='語彙表',
            font_size='16sp',
            background_color=[0.6, 0.8, 0.4, 1],
            color=[1, 1, 1, 1]
        )
        vocab_btn.bind(on_press=self.show_vocab)
        button_layout.add_widget(vocab_btn)
        
        self.add_widget(button_layout)
        
        # パニパニ出力エリア
        panipani_label = Label(
            text='パニパニ語:',
            size_hint_y=None,
            height=30,
            font_size='16sp',
            halign='left',
            color=[0.3, 0.3, 0.3, 1]
        )
        panipani_label.bind(size=panipani_label.setter('text_size'))
        self.add_widget(panipani_label)
        
        self.panipani_output = TextInput(
            multiline=True,
            readonly=True,
            size_hint_y=None,
            height=80,
            font_size='18sp',
            background_color=[0.9, 0.95, 1, 1],
            foreground_color=[0.1, 0.1, 0.6, 1],
            font_name='Arial'  # 読みやすいフォント
        )
        self.add_widget(self.panipani_output)
        
        # 分析結果エリア
        analysis_label = Label(
            text='翻訳分析:',
            size_hint_y=None,
            height=30,
            font_size='16sp',
            halign='left',
            color=[0.3, 0.3, 0.3, 1]
        )
        analysis_label.bind(size=analysis_label.setter('text_size'))
        self.add_widget(analysis_label)
        
        scroll = ScrollView()
        self.analysis_output = Label(
            text='',
            text_size=(None, None),
            halign='left',
            valign='top',
            font_size='14sp',
            color=[0.4, 0.4, 0.4, 1]
        )
        scroll.add_widget(self.analysis_output)
        self.add_widget(scroll)
    
    def translate(self, instance):
        """翻訳実行"""
        japanese = self.japanese_input.text.strip()
        if not japanese:
            return
        
        # 翻訳実行
        panipani = self.translator.translate_sentence(japanese)
        self.panipani_output.text = panipani
        
        # 分析結果作成
        processed = self.translator.preprocess_japanese(japanese)
        words = processed.split()
        analysis_lines = []
        
        for word in words:
            translated = self.translator.translate_word(word)
            if translated == word:
                analysis_lines.append(f"'{word}' → '{translated}' (借用語)")
            else:
                meaning = self.translator.panipani_vocab.get(translated, "不明")
                analysis_lines.append(f"'{word}' → '{translated}' ({meaning})")
        
        self.analysis_output.text = '\n'.join(analysis_lines)
        # テキストサイズを動的に調整
        self.analysis_output.text_size = (self.analysis_output.parent.width - 20, None)
    
    def clear_all(self, instance):
        """全てクリア"""
        self.japanese_input.text = ''
        self.panipani_output.text = ''
        self.analysis_output.text = ''
    
    def show_vocab(self, instance):
        """語彙表ポップアップ表示"""
        content = BoxLayout(orientation='vertical', spacing=10, padding=10)
        
        scroll = ScrollView()
        vocab_lines = []
        for word, meaning in self.translator.panipani_vocab.items():
            vocab_lines.append(f'{word}: {meaning}')
        
        vocab_label = Label(
            text='\n'.join(vocab_lines),
            text_size=(350, None),
            halign='left',
            valign='top',
            font_size='14sp',
            color=[0.2, 0.2, 0.2, 1]
        )
        scroll.add_widget(vocab_label)
        content.add_widget(scroll)
        
        close_btn = Button(
            text='閉じる',
            size_hint_y=None,
            height=50,
            font_size='16sp',
            background_color=[0.6, 0.6, 0.6, 1],
            color=[1, 1, 1, 1]
        )
        content.add_widget(close_btn)
        
        popup = Popup(
            title='パニパニ語彙表 (17語)',
            content=content,
            size_hint=(0.9, 0.8),
            title_size='18sp'
        )
        close_btn.bind(on_press=popup.dismiss)
        popup.open()

class PaniPaniApp(App):
    def build(self):
        return MainWidget()

if __name__ == '__main__':
    PaniPaniApp().run()
